-- # Verificar se todas as tabelas tem o statseq como valor padrão 1
	
-- # CRIAR TABELA DBPARAMETRO_PRODUTO

CREATE TABLE dbparametro_produto (
	seq serial,    
	unidseq bigint NOT NULL,
    usuaseq bigint NOT NULL,
    tabela character varying(60),
    collabel character varying(60),
    colvalor character varying(200),
    coldesc character varying(80),
    datacad date DEFAULT ('now'::text)::date NOT NULL,
    tpprseq bigint NOT NULL,
    statseq bigint DEFAULT 1 NOT NULL
);
   
-- # TABELA PROJETO_CURSO

   ALTER TABLE dbprojeto_curso
   ADD COLUMN stpcseq bigint NOT NULL DEFAULT 4;
   
   ALTER TABLE dbprojeto_curso
   ADD COLUMN identificador varchar(20) NOT NULL DEFAULT '--';
   
-- # View de projeto_curso

CREATE OR REPLACE VIEW view_projeto_curso AS 
 SELECT t1.seq, t1.unidseq, t1.usuaseq, t1.nome, t1.tpcuseq, t1.arcuseq, t1.objetivo, t1.publicoalvo, to_char(t1.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t999.seq AS statseq, t999.statdesc, t2.titulo AS areacurso, ( SELECT sum(t4.cargahoraria) AS sum
           FROM dbdisciplina t4
          WHERE (t4.seq IN ( SELECT t5.discseq
                   FROM dbprojeto_curso_disciplina t5
                  WHERE t5.pjcuseq = t1.seq))) AS cargahoraria, t3.titulo AS tipocurso, ( SELECT count(t5.cursseq) AS count
           FROM dbturma t5
          WHERE t5.cursseq = t1.seq) AS turmas, t1.gdavseq, t1.identificador, t1.stpcseq
   FROM dbprojeto_curso t1
   LEFT JOIN dbarea_curso t2 ON t2.seq = t1.arcuseq
   LEFT JOIN dbtipo_curso t3 ON t3.seq = t1.tpcuseq
   LEFT JOIN dbstatus t999 ON t999.seq = t1.statseq;

ALTER TABLE view_projeto_curso
  OWNER TO postgres;

-- # VIEW de curso_disciplina

-- View: view_curso_disciplina

-- DROP VIEW view_curso_disciplina;

CREATE OR REPLACE VIEW view_curso_disciplina AS 
 SELECT t2.seq, t0.unidseq, t0.usuaseq, t0.pjcuseq, t3.seq AS discseq, to_char(t0.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t999.seq AS statseq, t999.statdesc, t1.nome AS nomecurso, t3.titulo AS nomedisciplina, t3.cargahoraria, t0.seq AS cursseq
   FROM dbcurso t0
   JOIN dbprojeto_curso t1 ON t1.seq = t0.pjcuseq
   JOIN dbprojeto_curso_disciplina t2 ON t2.pjcuseq = t0.pjcuseq
   LEFT JOIN dbdisciplina t3 ON t3.seq = t2.discseq
   LEFT JOIN dbstatus t999 ON t999.seq = t0.statseq;

ALTER TABLE view_curso_disciplina
  OWNER TO postgres;

ALTER TABLE dbturma_disciplina
   ALTER COLUMN gdavseq DROP NOT NULL;

ALTER TABLE dbturma
   ALTER COLUMN valortaxa SET DEFAULT 0;
ALTER TABLE dbturma
   ALTER COLUMN valortaxa DROP NOT NULL;
ALTER TABLE dbturma
   ALTER COLUMN prodseq DROP NOT NULL;
ALTER TABLE dbturma
   ALTER COLUMN horainicio DROP NOT NULL;
ALTER TABLE dbturma
   ALTER COLUMN horafim DROP NOT NULL;
   
 -- VIEW TURMA

CREATE OR REPLACE VIEW view_turma AS 
 SELECT t2.nome AS nomeprojetocurso, t0.seq, t0.unidseq, t0.titulo, t0.aceitainscricao, ( SELECT sum(t4.cargahoraria) AS sum
           FROM dbdisciplina t4
          WHERE (t4.seq IN ( SELECT t5.discseq
                   FROM dbturma_disciplina t5
                  WHERE t5.turmseq = t0.seq))) AS cargahoraria, 
                  t0.valortaxa, 
                  t0.valormatricula, 
                  t0.valormensal, 
                  t0.vagas, 
                  t0.parcelas, 
                  t0.sttuseq, 
                  t999.seq AS statseq, 
                  t999.statdesc, 
                  t0.datainicio, 
                  t0.prodseq, 
                  t3.nomeunidade, 
                  t0.cursseq, 
                  t2.nome AS nomecurso, 
                  ( SELECT count(t5.turmseq) AS count
           FROM dbinscricao t5
          WHERE t5.turmseq = t0.seq) AS inscritos, ( SELECT count(t6.turmseq) AS count
           FROM dbaluno t6
          WHERE t6.turmseq = t0.seq) AS matriculados, to_char(t0.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t2.gdavseq, t4.titulo AS referencia
   FROM dbturma t0
   LEFT JOIN dbcurso t4 ON t4.seq = t0.cursseq
   LEFT JOIN dbprojeto_curso t2 ON t2.seq = t4.pjcuseq
   LEFT JOIN dbunidade t3 ON t3.seq = t0.unidseq
   LEFT JOIN dbstatus t999 ON t999.seq = t0.statseq;
 
CREATE INDEX dbturma_disciplina_turmseq_discseq_idx
  ON dbturma_disciplina
  USING btree
  (turmseq, discseq);
  
  
CREATE INDEX dbturma_cursseq_idx
  ON dbturma
  USING btree
  (cursseq);
  

CREATE INDEX dbprojeto_curso_disciplina_pjcuseq_idx
  ON dbprojeto_curso_disciplina
  USING btree
  (pjcuseq);
  
  ALTER TABLE dbtransacao
   ALTER COLUMN intervaloparcelas DROP NOT NULL;
   
   
 -- Alterações apartir de 18/12/2013
 
 CREATE VIEW view_telefone AS
	select 
		t1.seq,
		t1.unidseq,
		t1.usuaseq,
		t1.pessseq,
		t1.telefone,
		t1.codigoarea,
		t1.datacad,
		t1.statseq,
		t1.tpteseq,
		t2.tptedesc,
		t2.prioridade
	from dbtelefone AS t1
	LEFT JOIN dbtipo_telefone AS t2 ON t2.seq = t1.tpteseq
	
CREATE OR REPLACE VIEW view_turma_disciplina AS 
 SELECT t0.seq, t0.unidseq, t0.turmseq, t3.cursseq, t0.discseq, t0.profseq, to_char(t0.datarealizacao::timestamp with time zone, 'DD/MM/YYYY'::text) AS datarealizacao, to_char(t0.dataatualizacao::timestamp with time zone, 'DD/MM/YYYY'::text) AS dataatualizacao, t0.frequencia, t0.datas, t0.custohoraaula, t0.regimetrabalho, t0.custohospedagem, t0.custodeslocamento, to_char(t0.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t6.nome AS sala, t999.seq AS statseq, t999.statdesc, t7.nome AS nomecurso, t3.titulo AS nometurma, t4.titulo AS nomedisciplina, t4.cargahoraria, t5.pessnmrz AS nomeprofessor, ( SELECT count(dbaluno_disciplina.seq) AS count
           FROM dbaluno_disciplina
          WHERE dbaluno_disciplina.tudiseq = t0.seq AND dbaluno_disciplina.stadseq = 2::bigint) AS alunos, t0.salaseq, t7.gdavseq, t3.sttuseq, t0.custoalimentacao, t0.custoextra
   FROM dbturma_disciplina t0
   LEFT JOIN dbturma t3 ON t3.seq = t0.turmseq
   LEFT JOIN dbcurso t2 ON t2.seq = t3.cursseq
   LEFT JOIN dbprojeto_curso t7 ON t7.seq = t2.pjcuseq
   LEFT JOIN dbdisciplina t4 ON t4.seq = t0.discseq
   LEFT JOIN dbpessoa t5 ON t5.seq = (( SELECT t9.pessseq
   FROM dbprofessor t9
  WHERE t9.seq = t0.profseq))
   LEFT JOIN dbsala t6 ON t6.seq = t0.salaseq
   LEFT JOIN dbstatus t999 ON t999.seq = t0.statseq;

ALTER TABLE view_turma_disciplina
  OWNER TO postgres;

	
-- Alterações apartir de 09/01/2014
	 
ALTER TABLE dbturma_disciplina
   ADD COLUMN cargahoraria numeric NOT NULL DEFAULT 1;
	
	
	
DROP VIEW view_turma_disciplina_aula;
CREATE OR REPLACE VIEW view_turma_disciplina_aula AS 
 SELECT 
 t1.seq, 
 t1.unidseq, 
 t1.usuaseq, 
 t1.tudiseq, 
 to_char(t1.dataaula::timestamp with time zone, 'DD/MM/YYYY'::text) AS dataaula, 
 t1.conteudo, 
 t1.frequencia, 
 t1.obs,
 t0.turmseq, 
 t3.cursseq, 
 t0.discseq, 
 t0.profseq, 
 t0.frequencia AS frequenciatotal,
 t6.nome AS sala, 
 t7.nome AS nomecurso, 
 t3.titulo AS nometurma, 
 t4.titulo AS nomedisciplina, 
 t4.cargahoraria, 
 t5.pessnmrz AS nomeprofessor, 
 ( SELECT count(dbaluno_disciplina.seq) AS count
           FROM dbaluno_disciplina
          WHERE dbaluno_disciplina.tudiseq = t0.seq AND dbaluno_disciplina.stadseq = 2::bigint) AS alunos, 
 t0.salaseq, 
 t3.sttuseq, 
 to_char(t1.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, 
 t999.seq AS statseq, 
 t999.statdesc 
   FROM dbturma_disciplina_aula t1
   LEFT JOIN dbturma_disciplina t0 ON t0.seq = t1.tudiseq
   LEFT JOIN dbturma t3 ON t3.seq = t0.turmseq
   LEFT JOIN dbcurso t2 ON t2.seq = t3.cursseq
   LEFT JOIN dbprojeto_curso t7 ON t7.seq = t2.pjcuseq
   LEFT JOIN dbdisciplina t4 ON t4.seq = t0.discseq
   LEFT JOIN dbpessoa t5 ON t5.seq = (( SELECT t9.pessseq
   FROM dbprofessor t9
  WHERE t9.seq = t0.profseq))
   LEFT JOIN dbsala t6 ON t6.seq = t0.salaseq
   LEFT JOIN dbstatus t999 ON t999.seq = t1.statseq;

ALTER TABLE dbaproveitamento_disciplina
   ADD COLUMN instituicao character varying(200);
   
-- Alterações a partir de 24/01/2014

ALTER TABLE dbboleto_estrutura
   ADD COLUMN template character varying(200) NOT NULL DEFAULT '../../sysboleto/boleto_petrus.php';


ALTER TABLE dbturma
   ADD COLUMN cofiseq integer;
   
ALTER TABLE dbturma
  ADD CONSTRAINT fk_cofi_parc_cofiseq FOREIGN KEY (cofiseq)
  REFERENCES dbconta_financeira (seq) MATCH SIMPLE
  ON UPDATE RESTRICT ON DELETE RESTRICT;
  
  update dbturma set cofiseq = 3;
  
ALTER TABLE dbturma
   ALTER COLUMN cofiseq SET NOT NULL;
   
ALTER TABLE dbtransacao
   ADD COLUMN cofiseq integer;
   
ALTER TABLE dbtransacao
  ADD CONSTRAINT fk_cofi_tran_cofiseq FOREIGN KEY (cofiseq)
  REFERENCES dbconta_financeira (seq) MATCH SIMPLE
  ON UPDATE RESTRICT ON DELETE RESTRICT;
  
  update dbtransacao set cofiseq = 3;
  
ALTER TABLE dbtransacao
   ALTER COLUMN cofiseq SET NOT NULL;

   ALTER TABLE dbparcela
   ADD COLUMN cofiseq integer;
   
ALTER TABLE dbparcela
  ADD CONSTRAINT fk_cofi_parc_cofiseq FOREIGN KEY (cofiseq)
  REFERENCES dbconta_financeira (seq) MATCH SIMPLE
  ON UPDATE RESTRICT ON DELETE RESTRICT;
  
  update dbparcela set cofiseq = 3;
  
ALTER TABLE dbparcela
   ALTER COLUMN cofiseq SET NOT NULL;
   
CREATE OR REPLACE VIEW view_inscricao AS 
 SELECT t0.seq, t0.unidseq, t0.usuaseq, t0.pessseq, t0.transeq, t0.turmseq, t4.seq AS cursseq, to_char(t0.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t999.seq AS statseq, t999.statdesc, t2.pessnmrz AS nomepessoa, t2.pessnmrf, t3.titulo AS nometurma, t3.datainicio, t3.valortaxa, t3.parcelas, t3.valormatricula, t3.valormensal AS valorparcelas, t5.nome AS nomecurso, t0.vencimentomatricula, t0.vencimentotaxa, t3.datainiciovencimentos, t3.padraovencimento, t3.cofiseq
   FROM dbinscricao t0
   LEFT JOIN dbpessoa t2 ON t2.seq = t0.pessseq
   LEFT JOIN dbturma t3 ON t3.seq = t0.turmseq
   LEFT JOIN dbcurso t4 ON t4.seq = t3.cursseq
   LEFT JOIN dbprojeto_curso t5 ON t5.seq = t4.pjcuseq
   LEFT JOIN dbstatus t999 ON t999.seq = t0.statseq;
   
   
update dbboleto_estrutura set cofiseq = 3;

-- View: view_parcela

-- DROP VIEW view_parcela;

CREATE OR REPLACE VIEW view_parcela AS 
 SELECT t0.seq, t0.unidseq, t0.usuaseq, t0.transeq, t1.pessseq, t0.plcoseq, t0.tipo, t0.valorinicial, t0.valoratual, t0.numero, t0.desconto, to_char(t0.vencimento::timestamp with time zone, 'DD/MM/YYYY'::text) AS vencimento, t0.obs, t0.stpaseq, to_char(t0.datacad::timestamp with time zone, 'DD/MM/YYYY'::text) AS datacad, t2.pessnmrz AS nomepessoa, t3.nomeconta AS nomeplanoconta, t0.instrucoespagamento, t999.seq AS statseq, t999.statdesc AS statdescr, t5.valorfinal AS valorfinal_credito, t6.valorfinal AS valorfinal_debito, t8.titulo AS stpadesc,t0.cofiseq
   FROM dbparcela t0
   LEFT JOIN dbtransacao t1 ON t1.seq = t0.transeq
   LEFT JOIN dbpessoa t2 ON t2.seq = t1.pessseq
   LEFT JOIN dbplano_conta t3 ON t3.seq = t0.plcoseq
   LEFT JOIN dbstatus t999 ON t999.seq = t0.statseq
   LEFT JOIN dbsituacao_parcela t8 ON t8.seq = t0.stpaseq
   LEFT JOIN ( SELECT sum(dbcaixa.valorfinal) AS valorfinal, dbcaixa.parcseq
   FROM dbcaixa
  WHERE dbcaixa.tipo = 'C'::bpchar
  GROUP BY dbcaixa.parcseq) t5 ON t0.seq = t5.parcseq
   LEFT JOIN ( SELECT sum(dbcaixa.valorfinal) AS valorfinal, dbcaixa.parcseq
   FROM dbcaixa
  WHERE dbcaixa.tipo = 'D'::bpchar
  GROUP BY dbcaixa.parcseq) t6 ON t0.seq = t6.parcseq;


ALTER TABLE dbconvenio
   ALTER COLUMN pessseq DROP NOT NULL;
   
ALTER TABLE dbboleto_estrutura
   ADD COLUMN  prefixo_nosso_numero character varying(20);
ALTER TABLE dbboleto_estrutura
   ADD COLUMN   digitos_nosso_numero integer;
ALTER TABLE dbboleto_estrutura
   ADD COLUMN   codigo_cedente character varying(20);
ALTER TABLE dbboleto_estrutura
   ADD COLUMN   convenio character varying(20);
 ALTER TABLE dbboleto_estrutura
   ADD COLUMN  contrato character varying(20);
ALTER TABLE dbboleto_estrutura
   ADD COLUMN   variacao_carteira character varying(5);